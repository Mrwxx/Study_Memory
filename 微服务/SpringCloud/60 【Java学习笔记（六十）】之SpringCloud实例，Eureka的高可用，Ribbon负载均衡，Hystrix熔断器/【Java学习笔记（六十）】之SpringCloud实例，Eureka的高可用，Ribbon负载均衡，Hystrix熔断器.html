<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>【Java学习笔记（六十）】之SpringCloud实例，Eureka的高可用，Ribbon负载均衡，Hystrix熔断器</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><h2><a id="_0"></a>本文章由公号【开发小鸽】发布！欢迎关注！！！</h2>
<br>
<p><strong>老规矩–妹妹镇楼：</strong></p>
<center>
<img src="https://img-blog.csdnimg.cn/20200721223424816.JPG" width="20%">
</center><h2><a id="%09_8"></a>一．	系统架构的演变</h2>
<h3><a id="%09_9"></a>（一）	集中式架构</h3>
<h4><a id="1%09_10"></a>1.	概述</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 当网站的流量很小时，只需要一个应用，将所有的功能都部署在一起，以减少部署节点和成本。<br>
<br></p>
<h4><a id="2%09_15"></a>2.	优点</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 开发速度快，维护成本低。<br>
<br></p>
<h4><a id="3%09_21"></a>3.	缺点</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 代码耦合度高，维护困难，无法水平扩展，容错率低，并发能力差。</p>
<br>
<h3><a id="%09_27"></a>（二）	垂直拆分</h3>
<h4><a id="1%09_28"></a>1.	概述</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 由于访问量逐渐增大，单一的应用无法满足需求，需要根据业务功能对系统进行拆分。<br>
<br></p>
<h4><a id="2%09_34"></a>2.	优点</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 系统拆分实现了流量分担，解决了并发问题，可以针对不同的模块进行优化，方便水平扩展，负载均衡，提高容错率。<br>
<br></p>
<h4><a id="3%09_40"></a>3.	缺点</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 系统间相互独立，有很多重复开发工作。<br>
<br></p>
<h3><a id="%09_46"></a>（三）	分布式服务</h3>
<h4><a id="1%09_47"></a>1.	概述</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 当垂直应用越来越多时，应用之间的交互也增多了，我们可以将核心的业务抽取出来作为独立的服务，形成基础服务中心，这样其他应用调用这些常用的服务就很方便。<br>
<br></p>
<h4><a id="2%09_53"></a>2.	优点</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 抽取了基础服务，提高代码的复用和开发效率。<br>
<br></p>
<h4><a id="3%09_59"></a>3.	缺点</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 系统间耦合度增高，调用关系复杂，难以维护。</p>
<br>
<h3><a id="%09SOA_65"></a>（四）	面向服务结构（SOA）</h3>
<h4><a id="1%09_66"></a>1.	概述</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 包含多个服务，服务之间通过相互依赖提供一系列的功能。一个服务通常以独立的形式存在于操作系统进程中，各个服务之间通过网络调用。各个服务之间通过ESB（企业服务总线）连接，为了集成不同的服务，不同协议的服务，ESB做了消息的转化解释和路由工作，让不同的服务互联互通。<br>
<br></p>
<h4><a id="2%09_72"></a>2.	缺点</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 服务粒度较大，ESB集成整合所有服务和协议，数据使得部署，维护困难，且所有的服务都通过一个通道通信，降低了通信的速度。<br>
<br></p>
<h3><a id="%09_78"></a>（五）	微服务架构</h3>
<h4><a id="1%09_79"></a>1.	概述</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 微服务架构是使用一套小服务来开发单个应用的方式，每个服务基于单一业务能力构建，运行在自己的进程中，并使用轻量级机制通信，通常是HTTP API，并能够通过自动化部署来独立部署。这些服务可以使用不同语言，存储技术，并保持最低限度的集中式管理。<br>
<br></p>
<h4><a id="2%09_85"></a>2.	流程</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 终端通过一个Gateway网关来请求服务，服务通过服务注册中心进行服务注册和管理。网关是一个服务器，是系统的唯一入口，它为每个客户端提供一个定制的API，所有的客户端和消费端都是通过统一的网关接入微服务的，在网关层处理所有的非业务功能。如身份验证，监控，负载均衡，缓存，等等。网关提供RESTful/HTTP的方式访问服务。</p>
<br>
<h4><a id="3%09_91"></a>3.	特点</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; （1）	每个服务对应单一的业务。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; （2）	服务拆分粒度很小。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; （3）	每个服务只需要提供标准接口API，不论该服务如何实现。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; （4）	服务间相互独立，互不干扰。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; （5）	前后端分离，提供统一的Rest接口，后端不需要再为PC，移动端开发不同的接口。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; （6）	数据库分离，每个服务使用自己的数据源。<br>
<br></p>
<h4><a id="4%09SOA_107"></a>4.	微服务与SOA的区别</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 微服务架构和SOA都是对系统进行拆分，SOA中有ESB作为中心总线，而微服务做了去中心化处理，将ESB去掉了，更加灵活，着重分散管理，而不是中央管理。</p>
<br>
<h2><a id="%09_114"></a>二．	服务调用方式</h2>
<h3><a id="%09RPCHTTP_115"></a>（一）	RPC和HTTP</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 服务之间的远程调用方式有两种：RPC和HTTP。<br>
<br></p>
<h4><a id="1%09RPC_121"></a>1.	RPC</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; RPC全称为 Remote Produce Call远程过程调用，RPC是基于Socket，工作在会话层，自定义数据格式，速度快，效率高。代表产品为webservice,dubbo。<br>
<br></p>
<h4><a id="2%09HTTP_127"></a>2.	HTTP</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; http是一种网络传输协议，基于TCP,工作在应用层，规定了数据传输的格式。客户端和服务器的通信基本都是HTTP协议，缺点是消息封装臃肿，优点是对于服务的提供和调用没有技术限定，不会限制使用什么语言，技术，HTTP只负责消息的传递。Rest风格，Spring Cloud套件就是通过HTTP协议实现的。<br>
<br></p>
<h4><a id="%09RPCHTTP_133"></a>（二）	RPC与HTTP的区别</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; RPC是根据语言的API来定义的，而不是根据网络的应用来定义的。它会限制使用语言，技术的灵活性。如果使用的JAVA语言，那么使用Dubbo比较合适。<br>
如果不只是使用一种语言，技术，那么使用HTTP方式来实现服务间的调用更好。</p>
<br>
<h4><a id="%09Spring_RestTemplate_141"></a>（三）	Spring RestTemplate的使用</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 一般有三种http客户端工具类包可以方便地进行http服务调用：httpClient，okHttp，JDK原生URLConnection。Spring提供了RestTemplate的工具类对上述的三种http客户端工具进行了封装，可以直接在Spring项目中使用RestTempplate进行服务调用。</p>
<br>
<h2><a id="%09Spring_Cloud_148"></a>三．	Spring Cloud</h2>
<h3><a id="%09_149"></a>（一）	概述</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; Spring Cloud是Spring旗下的项目，完全支持Spring Boot的开发，用很少的配置就能够完成微服务框架的搭建。Spring Cloud能够将其他非常流行的技术整合到一起，如配置管理，服务发现，智能路由，负载均衡，熔断器，控制总线，集群状态等功能；协调分布式环境中各个系统，为各类服务提供模板性配置，<br>
<br></p>
<h3><a id="%09_155"></a>（二）	组件构成</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; Spring Cloud不是一个组件，而是许多组件的集合。主要的组件为：注册中心（Eureka），服务网关（Zuul, Gateway），负载均衡（Ribbon），服务调用（Feign），熔断器（Hystrix或Resilience4j）。当我们需要使用某些组件时，直接在项目中添加相关的启动器依赖即可。<br>
<br></p>
<h3><a id="%09_161"></a>（三）	流程</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 当请求通过网关进入后，负载均衡从服务注册中心中获取请求的地址列表，并基于负载均衡算法来选择一个地址来访问；如果服务之间有调用的需求，那么通过服务调用Feign进行调用；如果服务需要修改配置，那么从配置服务器中实时地更新配置。</p>
<br>
<h3><a id="%09_167"></a>（四）	版本</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; Spring Cloud 的版本不是普通的数字，而是使用伦敦地铁站的名字来命名的（脑残操作）。<br>
<br></p>
<h2><a id="_173"></a>四．服务提供方实例</h2>
<h3><a id="%09_174"></a>（一）.	创建项目工程</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 创建微服务父工程SpringCloudParentDemo，用户服务提供工程SpringCloudProducer，服务消费工程SpringCloudConsumer。后面两个工程继承父工程，父工程添加Spring Boot父坐标和管理其他组件的依赖；用户服务工程用于整合Mybatis查询数据库中用户数据，提供查询用户数据服务；服务消费工程用于调用查询用户服务数据并输出到浏览器。<br>
<br></p>
<h3><a id="%09pomxml_180"></a>（二）	配置父工程pom.xml</h3>
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.SpringCloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>com.SpringCloud.ParentDemo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>packaging</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>packaging</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modules</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>SpringCloudConsumer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>SpringCloudProducer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modules</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.5.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-cloud.version</span><span class="token punctuation">&gt;</span></span>Greenwich.SR1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-cloud.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper.starter.version</span><span class="token punctuation">&gt;</span></span>2.1.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper.starter.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mysql.version</span><span class="token punctuation">&gt;</span></span>5.1.46<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mysql.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- springCloud --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring-cloud.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- 通用Mapper启动器 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>tk.mybatis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mapper-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${mapper.starter.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- mysql驱动 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${mysql.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.16.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp;   modules标签内表示的是该父工程中子工程的名称；</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; parent标签内继承了SpringBoot启动器依赖；</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; properties标签内表示的是其他配置信息，如java版本，SpringCloud版本，mybatis版本，mysql驱动版本，后面可以直接引用这些版本信息。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; dependencyManagement标签内表示的是依赖的坐标管理，只是限定我们需要依赖的坐标，但是并没有真正地导入这些坐标。真正地导入坐标需要在每个子工程中自行导入。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 由于spring-cloud-dependencies依赖的scope是import，因此只要包括了该依赖的项目都能够继承该工程中的依赖，因此父工程项目不仅继承了spring-boot-parent，还继承了spring-cloud-dependencies，不需要自己再定义SpringCloud组件的版本了。</p>
<br>
<h3><a id="pomxml_273"></a>（三）配置服务提供子工程的pom.xml</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 由于父工程中已经配置了依赖的坐标管理，因此，我们直接在子工程导入已经管理的坐标即可，如Mapper启动器，mysql驱动，不需要定义版本。同时还有web启动器。</p>
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 通用Mapper启动器 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>tk.mybatis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mapper-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- mysql驱动 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<br>
<h3><a id="SpringBootappliactionyml_298"></a>（四）创建引导类和SpringBoot配置文件appliaction.yml</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 创建引导类入口:</p>
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">userApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SpringApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>userApplication<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<br>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 配置application.yml，其中包括服务器的端口号，使用数据源的驱动，地址，用户名，密码，同时还有设置mybatis别名包的扫描，这个包和包中的实体类需要自行创建。</p>
<pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9091</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/springcloud
    username<span class="token punctuation">:</span>root
    <span class="token key atrule">password</span><span class="token punctuation">:</span>

<span class="token key atrule">mybatis</span><span class="token punctuation">:</span>
  <span class="token key atrule">type-aliases-package</span><span class="token punctuation">:</span> com.user.pojo
</code></pre>
<br>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 创建实体类User:</p>
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>user<span class="token punctuation">.</span>pojo<span class="token punctuation">;</span>

<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>Data<span class="token punctuation">;</span>
<span class="token keyword">import</span> tk<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>KeySql<span class="token punctuation">;</span>

<span class="token keyword">import</span> javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span>Id<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span>Table<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Date<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"tb_user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">{</span>
    <span class="token comment">// id</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token comment">//开启主键自动回填</span>
    <span class="token annotation punctuation">@KeySql</span><span class="token punctuation">(</span>useGeneratedKeys <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> Long id<span class="token punctuation">;</span>

    <span class="token comment">// 用户名</span>
    <span class="token keyword">private</span> String userName<span class="token punctuation">;</span>

    <span class="token comment">// 密码</span>
    <span class="token keyword">private</span> String password<span class="token punctuation">;</span>

    <span class="token comment">// 姓名</span>
    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>

    <span class="token comment">// 年龄</span>
    <span class="token keyword">private</span> Integer age<span class="token punctuation">;</span>

    <span class="token comment">// 性别，1男性，2女性</span>
    <span class="token keyword">private</span> Integer sex<span class="token punctuation">;</span>

    <span class="token comment">// 出生日期</span>
    <span class="token keyword">private</span> Date birthday<span class="token punctuation">;</span>

    <span class="token comment">// 创建时间</span>
    <span class="token keyword">private</span> Date created<span class="token punctuation">;</span>

    <span class="token comment">// 更新时间</span>
    <span class="token keyword">private</span> Date updated<span class="token punctuation">;</span>

    <span class="token comment">// 备注</span>
    <span class="token keyword">private</span> String note<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<br>
<h3><a id="_389"></a>（五）创建数据表</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 根据需求创建数据表。<br>
<br></p>
<h3><a id="Mapper_395"></a>（六）创建Mapper接口</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; Mapper接口继承Mapper接口，并且要传入参数User对象。</p>
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>user<span class="token punctuation">.</span>mapper<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>user<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
<span class="token keyword">import</span> tk<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>common<span class="token punctuation">.</span>Mapper<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserMapper</span> <span class="token keyword">extends</span> <span class="token class-name">Mapper</span><span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 同时需要将该Mapper接口的全包名设置到引导类的注解@MapperScan的参数上面，用来扫描到这个Mapper包。<br>
<br></p>
<h3><a id="%09service_413"></a>（七）	创建service层的类</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 创建service层的类来调用Mapper的方法，查询用户User的数据。本次使用的是Mapper中固有的方法，通过主键查询，而不是自定义的UserMapper类中的方法。</p>
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>user<span class="token punctuation">.</span>service<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>user<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>UserMapper<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>user<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span>Service<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> UserMapper userMapper<span class="token punctuation">;</span>

    <span class="token keyword">public</span> User <span class="token function">queryById</span><span class="token punctuation">(</span>Long id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<br>
<h3><a id="controller_439"></a>（八）.创建controller层的类</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 创建UserController调用userService类的queryById方法，该方法的参数通过请求的地址中的id值来获取。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; @RestController是@Controller和@Responsebody的结合，代表着直接返回一个json字符串到页面上，而不是view；</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; @GetMapping 表示着这是一个Get请求方法的@RequestMapping注解；</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; @PathVariable 表示着从地址中取出某个参数；<br>
<br></p>
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> UserService userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{id}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> User <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> Long id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">queryById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<br>
<h3><a id="_468"></a>（九）测试代码运行情况</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 通过引导类运行Spring程序，访问localhost:8080/user/9将数据库根据id=9索引出来的数据显示在页面上。<br>
<br></p>
<h2><a id="_474"></a>五．服务消费方实例</h2>
<h3><a id="%09_475"></a>（一）	需求</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 微服务消费方的需求是访问localhost:8081/consumer/8 使用RestTemplate获取localhost:8080/user/8的数据。<br>
<br></p>
<h3><a id="pomxml_481"></a>（二）配置pom.xml</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 继承之前创建的父工程SpringCloudParentDemo，然后再添加一个web的启动依赖。</p>
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>com.SpringCloud.ParentDemo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.SpringCloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>SpringCloudConsumer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<br>
<h3><a id="_511"></a>（三）创建引导类和配置文件</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 创建一个引导类，同时需要在引导类中提前注册一个RestTemplate，以供调用。</p>
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerApp</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SpringApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>ConsumerApp<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> RestTemplate <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<br>
<h3><a id="Controller_531"></a>（四）创建Controller</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 添加一个Controller，其中有函数queryBuId（）通过RestTemplate将微服务提供的服务数据截取过来，返回一个User对象，这个User对象与服务提供方的User对象是一样的。注意，User对象一定要设置get和set方法，不然会出错。</p>
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/consumer"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> RestTemplate restTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> User <span class="token function">queryBuId</span><span class="token punctuation">(</span>Long id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        String url <span class="token operator">=</span> <span class="token string">"http://localhost:8081/user/8"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> User<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<br>
<h3><a id="_551"></a>（五）测试微服务消费方</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 启动引导类，访问localhost:8081/consumer/8，就会得到微服务提供方获取的数据库的数据，并显示在页面上。</p>
<br>
<h2><a id="_558"></a>六．总结项目的问题</h2>
<h3><a id="_559"></a>（一）服务管理</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 1. 服务如何自动注册和发现。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 2. 如何实现状态监管，服务提供方的状态和服务消费方的状态都是需要监测。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 3. 如何实现动态路由。<br>
<br></p>
<h3><a id="_569"></a>（二）负载均衡</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 当有多个服务器运行时，如何实现服务的负载均衡。</p>
<br>
<h3><a id="_575"></a>（三）容灾问题</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 当有服务器宕机时，如何解决容灾问题。<br>
<br></p>
<h3><a id="_581"></a>（四）服务统一配置问题</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 若有多个服务器，如何对多个服务器进行统一的配置。<br>
<br></p>
<h2><a id="_Eureka_588"></a>七． Eureka注册中心</h2>
<h3><a id="_589"></a>（一）概述</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 上面的服务项目实例中，服务提供方对外提供服务，需要对外暴露自己的地址，而服务调用者需要记录服务提供者的地址，将来地址出现变动时，需要及时更新。当服务数量比较少时，这些不会造成困扰，一旦服务数量增多，管理上就非常麻烦。这就需要服务注册中心来统一管理。<br>
<br></p>
<h3><a id="Eureka_595"></a>（二）Eureka注册中心</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; Eureka负责管理 ，记录服务提供者的消息；服务调用者无需自己寻找服务，而是把自己的需求告诉Eureka，然后Eureka会把符合你需求的服务提供给你。同时，服务提供方与Eureka之间通过“心跳”机制来进行监控，当某个服务提供方出现问题时，Eureka会把它从服务列表中删除。通过服务注册中心实现了服务的自动注册，发现，状态监控。<br>
<br></p>
<h3><a id="%09_601"></a>（三）	原理流程</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 1.	服务提供者实例化服务，将服务注册到Eureka服务注册中心中。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 2.	Eureka记录服务提供方的地址。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 3.	服务消费方从Eureka中获取服务列表的地址。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 4.	基于负载均衡算法从地址列表中选择一个服务地址调用服务。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 5.	服务提供方会定期发送心跳给Eureka，告诉它这个服务时可用的。Eureka会定期检查那些没有定期发送心跳的服务，将它们在一定时间内剔除出服务地址列表、</p>
<br>
<h2><a id="Eureka_616"></a>八．搭建Eureka注册中心工程</h2>
<h3><a id="pomxml_617"></a>（一）配置pom.xml</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 依然是继承之前设置的父工程SpringCloudParentDemo，然后添加eureka-server的启动依赖，这是netflix公司的，版本不需要设置，因为在父工程中已经添加了spring-cloud依赖了。</p>
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.springboot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>eureka-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>com.SpringCloud.ParentDemo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.SpringCloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>


<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<br>
<h3><a id="_651"></a>（二）创建引导类和配置文件</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 创建引导类，并且添加注解@EnableEurekaServer，表示这是一个Eureka服务器。</p>
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableEurekaServer</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaApp</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SpringApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>EurekaApp<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<br>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 添加配置文件application.yml，配置文件application.yml配置Eureka服务器的参数：</p>
<pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8082</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>server
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span> 
      <span class="token comment">#eureka服务地址，如果是集群的话，需要制定其他集群eureka的地址</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>127.0.0.1/8082/eureka
    <span class="token comment">#单个服务器不注册自己到Eureka中</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token comment">#不拉取服务</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; spring.application.name是Eureka服务的名称。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; eureka.client.service-url 是eureka服务的地址，当有多个服务器成集群时，需要指定其他集群eureka的地址</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; eureka.client.register-with-eureka：是否注册Eureka本身到Eureka中，在单个服务器中是无所谓的，当呈集群存在时，需要注册Eureka本身到Eureka中被其他Eureka发现。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; eureka.client.fetch-registry:是否需要拉取服务。<br>
<br></p>
<h3><a id="_697"></a>（三）服务的注册与发现</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 我们需要将服务提供方的服务注册到eureka并且在服务消费方能够根据服务名称调用服务。</p>
<h4><a id="1%09_699"></a>1.	服务注册</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp;  （1）	在服务提供方添加Eureka客户端依赖，自动将服务注册到EurekaServer服务地址列表中。</p>
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<br>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp;  （2）	改造引导类，添加开启Eureka客户端发现的注解。</p>
<pre><code class="prism language-xml">@EnableEurekaClient
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 该注解用于开启Eureka客户端的发现功能。<br>
<br></p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; （3）	修改配置文件，添加服务提供方的应用名称，设置Eureka服务地址。</p>
<pre><code class="prism language-xml">spring.application.name=user-service
eureka.client.service-url.defaultZone=http://127.0.0.1:8082/eureka
</code></pre>
<br>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp;  （4）	启动测试<br>
&nbsp;  &nbsp;  &nbsp;  &nbsp; 在Eureka服务器已经开启的情况下，开启服务提供方，那么服务提供方就会出现在Eureka的管理界面上。</p>
<br>
<h4><a id="2%09_741"></a>2.	服务发现</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp;  （1）	在服务消费方添加Eureka客户端依赖，可以使用工具类根据服务名称获取对应的服务地址列表。</p>
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<br>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; （2）	改造引导类，添加开启Eureka客户端发现的注解。</p>
<pre><code class="prism language-xml">@EnableEurekaClient
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 该注解用于开启Eureka客户端的发现功能。<br>
<br></p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; （3）	修改配置文件，设置Eureka服务地址，并且设置服务消费方的名称。</p>
<pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>8082/eureka
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> consumer<span class="token punctuation">-</span>demo
</code></pre>
<br>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; （4）	改造Controller，使用工具类DiscoveryClient根据服务名称获取的对应服务地址列表。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 原来的Controller中服务提供方的地址是直接写死在代码中的，这样不利于扩展，我们可以注入一个工具类DiscoveryClient，该工具类可以获取Eureka服务器中注册的服务实例，通过该实例可以过去该实例的主机，以及端口号，以此可以拼接成该服务的地址。再通过RestTemplate的getForObject函数来访问该地址，得到服务提供的数据。</p>
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/consumer"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> RestTemplate restTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> DiscoveryClient discoveryClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{id}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> User <span class="token function">queryBuId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> Long id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        String url <span class="token operator">=</span> <span class="token string">"http://localhost:8080/user/8"</span><span class="token punctuation">;</span>

        <span class="token comment">//获取eureka中注册的user-service的实例</span>
        List<span class="token generics function"><span class="token punctuation">&lt;</span>ServiceInstance<span class="token punctuation">&gt;</span></span> serviceInstances <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span><span class="token string">"user-service"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ServiceInstance serviceInstance <span class="token operator">=</span> serviceInstances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        url <span class="token operator">=</span> <span class="token string">"http://"</span> <span class="token operator">+</span> serviceInstance<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> serviceInstance<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/user/"</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> User<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<br>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; （5）	测试服务消费方<br>
&nbsp;  &nbsp;  &nbsp;  &nbsp; 开启服务消费方，可以得到服务提供方提供的服务数据，并且服务提供方和服务消费方都已经在Eureka管理界面中了。<br>
<br></p>
<h2><a id="Eureka_Server_820"></a>九．高可用的Eureka Server</h2>
<h3><a id="_821"></a>（一）概述</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 在之前的案例中，我们搭建了一个EurekaServer，而EurekaServer也可以是一个集群，形成高可用的Eureka中心。所谓的高可用，就是保证当一个Eureka Server宕机后，另一个Eureka Server 能够立即补上去，这就需要多个Eureka Server之间需要数据同步。<br>
<br></p>
<h3><a id="_827"></a>（二）服务同步</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 多个Eureka Server之间能够互相注册为服务，集群中的每个Eureka Server 需要将自己注册到其他Eureka Server 服务之中，这样其他的Eureka Server就能够互相发现。当服务提供者注册到Eureka Server集群中的某个节点时，该节点会把服务的信息同步给集群中的每个节点，从而实现数据同步。因此，无论客户端访问到Eureka Server集群中的任意一个节点，都能够获取到完整的服务列表信息。<br>
<br></p>
<h3><a id="Eureka_Server_833"></a>（三）配置高可用的Eureka Server</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 直接修改之前配置的Eureka Server，之前配置的Eureka 的服务地址使用的是自己的Eureka Server地址，现在我们要配置集群，需要修改为其他服务器的地址。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 需要将自己注册到Eureka 中，设置register-with-eureka，默认是true。<br>
<br></p>
<pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>port<span class="token punctuation">:</span><span class="token number">8082</span><span class="token punctuation">}</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>server
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token comment">#eureka服务地址，如果是集群的话，需要制定其他集群eureka的地址</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>defaultZone<span class="token punctuation">:</span>http<span class="token punctuation">:</span>//127.0.0.1/8083/eureka<span class="token punctuation">}</span>
</code></pre>
<br>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 这里，我们使用一种新的语法：</p>
<pre><code class="prism language-xml">port: ${port:8082}
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 这种语法的意思是如果port中有值的话，就使用port中的值，否则使用后面的值。要使用这种语法，需要设置这些参数的默认值，在IDEA的右上角选择Eureka 项目的配置，在Configuration 的Environment中，设置VM options为使用的参数的默认值，使用-D表示这是默认值。如下所示：</p>
<pre><code class="prism language-xml">-Dport=8082 -DdefaultZone=http://127.0.0.1:8083/eureka
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 可以看到，这里设置的port默认值为8082，这是本台Eureka Server的端口号，defaultZone的默认值为其他Eureka Server 的地址，即如果有集群，则注册其他的Eureka Server的地址到本台Eureka Server中。<br>
<br></p>
<h3><a id="Eureka_Server_875"></a>（四）复制配置好的Eureka Server应用</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 同样是在Eureka Server的应用配置页面，直接复制该应用，得到另一个Eureka Server，修改名称，并且修改参数的默认值，将port的默认值改为新的端口号8083，将defaultZone的默认值改为http://127.0.0.1:8082/eureka。<br>
<br></p>
<h3><a id="%09_881"></a>（五）	测试高可用集群</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 同时启动两个Eureka Server应用，可以在两个的Eureka 管理界面中看到，每个都已经注册了两个Eureka Server了，一个是8082端口，一个是8083端口。设置服务提供方和服务消费方中配置的都是8082端口的服务器，当我们停掉8082端口的服务器时，发现服务提供方和服务消费方依旧能够运行。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 在配置服务提供者和服务消费方时，为了保证稳定，我们可以将多个Eureka Server的地址都配置到其中。</p>
<br>
<h2><a id="Eureka_890"></a>十．Eureka客户端与服务端配置</h2>
<h3><a id="Eureka_891"></a>（一）Eureka服务提供方客户端配置</h3>
<h4><a id="1__892"></a>1. 服务注册</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 服务提供者在启动时，会检测配置属性中的 eureka.client.register-with-eruka-true参数是否正确，默认是true。如果值是true，那么服务提供者就会向Eureka Server发起一个Rest请求，并携带自己的元数据信息，Eureka Server会把这些信息保存到一个双层Map结构中。双层Map结构如下所示：</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 第一层Map的Key是服务id。根据我们配置的spring.application.name属性来获取。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 第二层Map的Key是服务的实例id，一般是host+serviced+port.</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 值是服务的实例对象，一个服务可以启动多个不同的实例，形成集群。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 且，在默认注册时是使用的是主机名或者localhost，如果想用ip进行注册，需要在服务提供者的配置中手动添加ip地址，并且设置倾向ip地址：</p>
<pre><code class="prism language-yml">eureka：
	<span class="token key atrule">instance</span><span class="token punctuation">:</span>
		<span class="token key atrule">ip-address</span><span class="token punctuation">:</span> 127.0.0.1
		prefer<span class="token punctuation">-</span>ip<span class="token punctuation">-</span>address：true
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 注意，这样设置之后，只是在代码中变成了ip地址，然而Eureka的控制台中依然是localhost。<br>
<br></p>
<h4><a id="2_915"></a>2．服务续约</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 注册服务以后，服务提供者会持续地提供一个心跳，即定时向Eureka Server 发起Rest请求，表示该服务依旧存在，这种操作称为服务续约。服务提供方默认的定时续约的间隔时间为30秒，同时默认的服务失效的等待心跳时间为90秒，即若服务提供方90秒内没有心跳，则该服务就会失效，但是服务何时从Eureka Server服务列表中剔除出来，就要看Eureka Server定时扫描时间的设置了，只有Eureka Server定时扫描发现服务没有发送心跳时，他才会从服务列表中剔除。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 设置服务续约的参数，如下所示：</p>
<pre><code class="prism language-yml"><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
	<span class="token key atrule">instance</span><span class="token punctuation">:</span>
		<span class="token comment">#服务失效</span>
		<span class="token key atrule">lease-expiration-duration-in-seconds</span><span class="token punctuation">:</span> <span class="token number">90</span>
		<span class="token comment">#服务续约</span>
		<span class="token key atrule">leas-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
</code></pre>
<br>
<h3><a id="%09Eureka_933"></a>（二）	Eureka服务消费方客户端配置</h3>
<h4><a id="1%09_934"></a>1.	获取服务列表</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 当服务消费方启动时，会检测Eureka.client.fetch-registry参数的值，如果是true，那么会从Eureka Server的服务列表中拉取只读备份，缓存在本地中，每隔30秒重新拉取更新。在服务消费方的配置中修改如下参数：</p>
<pre><code class="prism language-yml"><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
		<span class="token key atrule">client</span><span class="token punctuation">:</span>
			<span class="token key atrule">registry-fetch-interval-seconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
</code></pre>
<br>
<h3><a id="%09Eureka_Server_946"></a>（三）	Eureka Server服务端配置</h3>
<h4><a id="1%09_947"></a>1.	服务下线</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 当服务正常关闭时，它会触发一个服务下线的Rest请求给Eureka Server，服务器接收到该请求后将服务设置为下线状态。<br>
<br></p>
<h4><a id="2%09_953"></a>2.	失效剔除</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 当Eureka Server没有收到服务下线的请求，同时Eureka Server有一个定时扫描任务，默认是60秒扫描一次当前服务清单中超时未续约的服务，并剔除出服务列表。可以通过eureka.server.eviction-interval-timer-in-ms 参数默认的时间，单位是毫秒。</p>
<pre><code class="prism language-yml"><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
	<span class="token key atrule">server</span><span class="token punctuation">:</span>
		<span class="token key atrule">eviction-interval-timer-in-ms</span><span class="token punctuation">:</span> <span class="token number">60000</span>
</code></pre>
<br>
<h4><a id="3%09_965"></a>3.	自我保护</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 当我们关停一个服务时，Eureka Server的控制台中会有一个警告，这是Eureka的自我为保护机制，当服务没有按时续约时，Eureka会统计该服务实例 最近15分钟续约的比例是否低于85%。由于网络的波动，服务未续约的情况时有发生，因此Eureka Server在扫描到有未续约的服务时，不会直接删除，而是等待网络恢复正常。这种保护机制保障了服务的稳定。在生产环境中比较实用，但是在开发过程中我们会频繁地打开关闭服务，因此，最好将自我保护机制关掉。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 可以通过在Eureka Server中设置如下参数关闭自我保护：</p>
<pre><code class="prism language-yml"><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
		<span class="token key atrule">server</span><span class="token punctuation">:</span>
			<span class="token key atrule">enable-self-preservation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre>
<br>
<h2><a id="_Ribbon_980"></a>十一. 负载均衡Ribbon</h2>
<h3><a id="%09_981"></a>（一）	概述</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 在实际开发中，一个服务一定有多个服务地址，当我们在服务消费方通过DiscoveryClient获取服务实例信息时，获取到的是一个服务地址列表，这时就需要负载均衡算法来决定到底访问哪一个服务。<br>
<br></p>
<h3><a id="%09Ribbon_987"></a>（二）	Ribbon</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; Eureka 中已经集成了负载均衡组件：Ribbon，这是Netflix发布的负载均衡器，它有助于控制HTTP和TCP客户端的行为，Ribbon配置服务提供者地址列表后，Ribbon就可以基于某种负载均衡算法，自动的为服务消费者去请求，包括轮询，随机等算法。Ribbon默认的负载均衡算法时轮询，通过在服务消费方的配置文件中修改如下参数：{服务名称}.ribbon.NFLoadBalancerRuleClassName，前面是服务的名称，后面是算法的名称。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 如：修改服务user-service为随机：</p>
<pre><code class="prism language-yml"><span class="token key atrule">user-service</span><span class="token punctuation">:</span>
	<span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
		<span class="token key atrule">NFLoadBalancerRuleClassName</span><span class="token punctuation">:</span> com.netflix.loadbalancer.RandomRule
</code></pre>
<br>
<h3><a id="%09_1002"></a>（三）	实现步骤</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 1.	要实现负载均衡，首先最起码要有两个及以上的服务提供方，创建一个8079端口，一个8080端口。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 2.	修改服务消费方的RestTemplate实例化方法，添加负载均衡注解@LoadBalnced</p>
<pre><code class="prism language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@LoadBalanced</span>
<span class="token keyword">public</span> RestTemplate <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 3.	修改服务消费方的controller，直接使用服务名称来替代原来的url中的host+port，这样Ribbon就能够自动负载均衡到一个服务地址中。</p>
<pre><code class="prism language-java">String url <span class="token operator">=</span> <span class="token string">"http://user-service/user/"</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
<span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> User<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<br>
<h3><a id="%09_1025"></a>（四）	实现原理</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 为何我们只在url中提供了服务的名称就可以实现负载均衡呢？显然是有组件根据服务名称，获取到了服务实例的ip和端口号。Spring的负载均衡自动配置类LoadBalancerAutoConfiguration.LoadBalancerInterceptorConfig会自动配置负载均衡拦截器LoadBalncertInterceptor。这个类会对RestTemplate的请求进行拦截，从Eureka中根据服务的名称获取到服务列表，最后根据负载均衡算法得到真实的服务地址信息，替换url地址。访问服务地址，并且获取服务数据。</p>
<br>
<h2><a id="_Hystrix_1032"></a>十二. 熔断器Hystrix</h2>
<h3><a id="%09_1033"></a>（一）	概述</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; Hystrix是一款提供保护机制的组件，由netflix公司研发。它是一个延迟和容错库，用于隔离访问远程服务，第三方库，防止出现级联失败。</p>
<br>
<h3><a id="%09_1039"></a>（二）	雪崩问题</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 在微服务的调用过程中，一个请求可能需要调用多个微服务接口才能够实现，调用过程比较复杂。当它调用的某一个服务发生异常时，请求被阻塞了，且这个线程并不会被释放，后面请求会继续发送来一直阻塞在这里。服务器资源被耗尽，导致其他服务都不可用了，形成了雪崩效应。Hystrix解决雪崩问题的手段是服务降级，包括线程隔离和服务降级。<br>
<br></p>
<h3><a id="%09_1045"></a>（三）	线程隔离</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; Hystrix为每个服务调用分配了一个小的线程池，如果线程池已经满调用了就立即拒绝服务调用，如果线程池中还有空闲的线程可以访问，则通过它来访问服务。<br>
<br></p>
<h3><a id="%09_1051"></a>（四）	服务降级</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 当线程池已经满了，或者请求超时时，则会进行服务降级处理。所谓的服务降级指的是返回一个服务调用失败的结果，至少用户的请求不会被阻塞，更不会无休止地等待到系统崩溃。<br>
<br></p>
<h3><a id="%09Hystrix_1057"></a>（五）	Hystrix实践</h3>
<h4><a id="1%09hystrix_1058"></a>1.	引入hystrix依赖</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 由于Hystrix是作用于服务消费方消费服务的时候，因此在服务消费方的pom.xml中添加依赖：</p>
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<br>
<h4><a id="2%09_1072"></a>2.	开启降级</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 在服务消费者的引导类上添加注解：@EnableCircuitBreaker</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 注意，在微服务中，服务消费方引导类通常会引入三个注解：</p>
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@EnableCircuitBreaker</span>
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 这三个注解可以组合成一个注解：<code>@SpringCloudApplication</code>，但是本人觉得还是不要合起来写最好。<br>
<br></p>
<h4><a id="3%09_1088"></a>3.	服务降级逻辑编写</h4>
<h5><a id="1_1089"></a>（1）概述</h5>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 当服务访问失败时，就会通过服务降级返回失败的结果，同样是在服务消费方的Controller中定义服务访问失败结果，我们需要定义一个新的方法，一个服务对应一个访问失败的方法。<br>
<br></p>
<h5><a id="2_1095"></a>（2）添加注解</h5>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 首先，要在该服务方法上面添加注解</p>
<pre><code class="prism language-xml">@HystrixCommand(fallbackMethod=”queryByIdFallBack”)
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 其中的参数fallbackMethod代表着该服务对应的访问失败方法，值为方法的名称。</p>
<br>
<h5><a id="3_1107"></a>（3）定义访问失败的方法</h5>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 定义这个访问失败的方法，注意，这个方法返回的一定是String，同样的，该方法对应的服务方法的返回值也要改为String，这是重点。</p>
<pre><code class="prism language-java">   <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{id}"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">"queryByIdFallBack"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">queryBuId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> Long id<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token comment">//        String url = "http://localhost:8080/user/8";</span>
<span class="token comment">//</span>
<span class="token comment">//        //获取eureka中注册的user-service的实例</span>
<span class="token comment">//        List&lt;ServiceInstance&gt; serviceInstances = discoveryClient.getInstances("user-service");</span>
<span class="token comment">//        ServiceInstance serviceInstance = serviceInstances.get(0);</span>
<span class="token comment">//        url = "http://" + serviceInstance.getHost() + ":" + serviceInstance.getPort() + "/user/" + id;</span>
        String url <span class="token operator">=</span> <span class="token string">"http://user-service/user/"</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">queryByIdFallBack</span><span class="token punctuation">(</span>Long id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"Sorry, the connection has failed"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<br>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 注意，原来的服务方法已经将返回值从User改为了String！！！</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 此时，进行测试，当我们停止服务提供方的运行时，服务消费方访问会返回失败方法的返回值。<br>
<br></p>
<h5><a id="4_1140"></a>（4）为类设置默认的访问失败方法</h5>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 为每个服务方法定义一个访问失败的方法是非常麻烦的，我们可以为整个类定义一个默认的访问失败的方法，作为该类中所有的服务访问失败的默认方法。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 在类上面添加注解</p>
<pre><code class="prism language-java"><span class="token annotation punctuation">@DefaultProperties</span><span class="token punctuation">(</span>defaultFallback<span class="token operator">=</span>”defaultFallback”<span class="token punctuation">)</span>
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 同样的，defaultFallback参数表示这是默认的访问失败方法，值为方法的名称。继而定义这个方法。</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 在对应的服务方法上添加注解@HystrixCommand，不过这次不用添加参数</p>
<pre><code class="prism language-java"><span class="token keyword">public</span> String <span class="token function">defaultFallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> “<span class="token keyword">default</span> fail”<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 我尝试着在对应的服务方法上依旧添加注解<code>@HystrixCommand(fallbackMethod = "queryByIdFallBack")</code>，这样可以为每个服务设定个性化的访问失败方法。<br>
<br></p>
<h4><a id="4%09Hystrix_1164"></a>4.	设置Hystrix访问超时时间</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 在服务消费方中配置Hystrix访问超时时间，通过以下参数：</p>
<pre><code class="prism language-yml"><span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
  <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
      <span class="token key atrule">execution</span><span class="token punctuation">:</span>
        <span class="token key atrule">isolation</span><span class="token punctuation">:</span>
          <span class="token key atrule">thread</span><span class="token punctuation">:</span>
            <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">3000</span>
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 这样，超时时间就设定为了3秒，当访问服务超过3秒没有响应时，那么就会启动服务降级，调用访问失败方法。我们可以通过浏览器自带的检查来查看访问该服务耗费的时间。<br>
<br></p>
<h2><a id="__1183"></a>十三. 服务熔断</h2>
<h3><a id="%09_1184"></a>（一）	熔断原理</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 在分布式系统中应用服务熔断后，服务调用方可以自己进行判断哪些服务反应慢或者存在大量超时，可以针对这些服务进行主动熔断，防止整个系统被拖垮。Hystrix的服务熔断机制，可以实现弹性容错，当服务请求情况好转以后，可以自动重连。通过断路的方式，将后续请求直接拒绝，一段时间（默认5秒）之后尝试地允许部分请求通过，如果这些请求调用成功则回到熔断器关闭的状态，否则继续打开熔断器，拒绝请求的服务。<br>
<br></p>
<h3><a id="%09Hystrix_1190"></a>（二）	Hystrix熔断状态机模型</h3>
<h4><a id="1%09closed_1191"></a>1.	closed</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 熔断器关闭状态，所有的需求都能够正常访问。<br>
<br></p>
<h4><a id="2%09open_1197"></a>2.	open</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 熔断器打开状态，所有的服务都会被降级。Hystrix会对请求情况进行继受，当一定时间内失败请求百分比达到阈值，则触发熔断，熔断器会完全打开。默认失败比例的阈值时50%，请求次数最少不低于20次。<br>
<br></p>
<h4><a id="3%09Half_open_1203"></a>3.	Half open</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 半开状态，不是永久的。熔断器打开后会进入休眠时间（默认是5s），随后熔断器会自动进入半开状态，此时会尝试地是释放部分请求，如果这些请求都能够执行成功的话，则会关闭熔断器，否则熔断器将继续保持打开，再次进行休眠计时。<br>
<br></p>
<h3><a id="%09_1209"></a>（三）	修改服务熔断的参数</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 我们可以在服务消费方中修改服务熔断的参数。如下所示：</p>
<pre><code class="prism language-yml"><span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
  <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
      <span class="token key atrule">cirouitBreaker</span><span class="token punctuation">:</span>
        <span class="token key atrule">errorThresholdPercentage</span><span class="token punctuation">:</span> <span class="token number">50  </span><span class="token comment">#触发熔断错误比例阈值</span>
        <span class="token key atrule">sleepWindowInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">10000 </span><span class="token comment">#熔断后休眠时间</span>
        <span class="token key atrule">requestVolumeThreshold</span><span class="token punctuation">:</span> <span class="token number">10  </span><span class="token comment">#熔断触发最小请求次数</span>
</code></pre>
<br>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; errorThresholdPercentage: 触发熔断错误比例阈值<br>
&nbsp;  &nbsp;  &nbsp;  &nbsp; sleepWindowInMilliseconds: 熔断后休眠的时间<br>
&nbsp;  &nbsp;  &nbsp;  &nbsp; requestVolumeThreshold: 熔断触发最小请求次数</p>
</div>
</body>

</html>
