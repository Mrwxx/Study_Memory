<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>26【OpenStack（Train版）安装部署（六2）】之Neutron服务在Controller节点和Compute节点的部署</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><p></p><div class="toc"><h3>文章目录</h3><ul><ul><li><a href="#_1">本文章由公号【开发小鸽】发布！欢迎关注！！！</a></li><li><a href="#%09ControllerNeutron_9">（一）	Controller节点安装Neutron服务</a></li><ul><li><a href="#1neutron_Controller_10">1.创建neutron数据库并授权 （Controller节点）</a></li><li><a href="#2_neutron_37">2. 创建neutron用户</a></li><li><a href="#3_neutronadmin_47">3. 向neutron用户添加admin角色</a></li><li><a href="#4_neutron_56">4. 创建neutron服务实体</a></li><li><a href="#5_neutron_65">5. 创建neutron服务端点</a></li><li><a href="#6__77">6. 安装软件包{配置二层网络}</a></li><li><a href="#7__neutron__95">7. 修改 neutron 配置文件</a></li><ul><li><a href="#1neutron_serverneutronconf_96">（1）neutron server的配置文件neutron.conf</a></li><li><a href="#2ML2_pluginml2_confini_260">（2）ML2 plugin的配置文件ml2_conf.ini</a></li><li><a href="#3linux_bridge_network_providerlinuxbridge_agentini_313">（3）linux bridge network provider的配置文件linuxbridge_agent.ini</a></li></ul><li><a href="#8_357">8.修改内核参数</a></li><li><a href="#9Linuxbridge_379">9.配置Linuxbridge接口驱动和外部网络网桥</a></li><li><a href="#10dhcp_agent__396">10.修改dhcp_agent 配置文件</a></li><li><a href="#11_nova_424">11. 配置元数据代理，以便和nova通讯</a></li><li><a href="#12novaneutron_445">12.修改nova配置文件，用于neutron交互</a></li><li><a href="#13ML2_464">13.创建ML2插件文件符号连接</a></li><li><a href="#14_474">14.初始化数据库</a></li><li><a href="#15novaapi_483">15.重启计算节点nova-api服务</a></li><li><a href="#16neutron_492">16.开启neutron服务、设置开机自启动</a></li></ul><li><a href="#Computeneutron_518">（二）Compute节点安装neutron服务</a></li><ul><li><a href="#1__519">1. 安装组件</a></li><li><a href="#2__529">2. 修改配置文件</a></li><ul><li><a href="#1neutron_530">（1）修改neutron主配置文件</a></li><li><a href="#2Linuxlinuxbridge_agentini_596">（2）配置Linux网桥代理linuxbridge_agent.ini</a></li><li><a href="#3_636">（3）修改内核</a></li></ul><li><a href="#3_novaconf_655">3. 修改nova.conf配置文件</a></li><li><a href="#4_nova_670">4. 重启nova计算服务</a></li><li><a href="#5_neutron_678">5. 启动neutron服务和设置开机自启动</a></li></ul><li><a href="#ControllerNeutron_687">（三）Controller节点中验证Neutron服务的安装</a></li><li><a href="#_705">（四）总结部署思路</a></li></ul></ul></div><p></p>
<h2><a id="_1"></a>本文章由公号【开发小鸽】发布！欢迎关注！！！</h2>
<br>
<p><strong>老规矩–妹妹镇楼：</strong></p>
<center>
<img src="https://img-blog.csdnimg.cn/20200721223424816.JPG" width="20%">
</center><h2><a id="%09ControllerNeutron_9"></a>（一）	Controller节点安装Neutron服务</h2>
<h3><a id="1neutron_Controller_10"></a>1.创建neutron数据库并授权 （Controller节点）</h3>
<pre><code class="prism language-cpp"><span class="token punctuation">[</span>root@controller <span class="token operator">~</span><span class="token punctuation">]</span># mysql <span class="token operator">-</span>uroot 
</code></pre>
<pre><code class="prism language-cpp">MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> CREATE DATABASE neutron<span class="token punctuation">;</span> 
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> row affected <span class="token punctuation">(</span><span class="token number">0.000</span> sec<span class="token punctuation">)</span> 
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; neutron数据库的登录密码是</p>
<pre><code class="prism language-cpp">NEUTRON_DBPASS
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> GRANT ALL PRIVILEGES ON neutron<span class="token punctuation">.</span><span class="token operator">*</span> TO <span class="token string">'neutron'</span>@<span class="token string">'localhost'</span>  IDENTIFIED BY <span class="token string">'NEUTRON_DBPASS'</span><span class="token punctuation">;</span> 
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.001</span> sec<span class="token punctuation">)</span> 
</code></pre>
<pre><code class="prism language-cpp">MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> GRANT ALL PRIVILEGES ON neutron<span class="token punctuation">.</span><span class="token operator">*</span> TO <span class="token string">'neutron'</span>@<span class="token string">'%'</span> IDENTIFIED BY <span class="token string">'NEUTRON_DBPASS'</span><span class="token punctuation">;</span> 
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.000</span> sec<span class="token punctuation">)</span>
</code></pre>
<br>
<h3><a id="2_neutron_37"></a>2. 创建neutron用户</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 创建openstack用户neutron，它的domain是default，密码是NEUTRON_PASS，用于在keystone做认证</p>
<pre><code class="prism language-cpp"><span class="token punctuation">[</span>root@controller <span class="token operator">~</span><span class="token punctuation">]</span># openstack user create <span class="token operator">--</span>domain <span class="token keyword">default</span> <span class="token operator">--</span>password NEUTRON_PASS neutron
</code></pre>
<br>
<h3><a id="3_neutronadmin_47"></a>3. 向neutron用户添加admin角色</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 角色是admin，所在的项目是service</p>
<pre><code class="prism language-cpp"><span class="token punctuation">[</span>root@controller <span class="token operator">~</span><span class="token punctuation">]</span># openstack role add <span class="token operator">--</span>project service <span class="token operator">--</span>user neutron admin
</code></pre>
<br>
<h3><a id="4_neutron_56"></a>4. 创建neutron服务实体</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; neutron服务实体，类型为network</p>
<pre><code class="prism language-cpp"><span class="token punctuation">[</span>root@controller <span class="token operator">~</span><span class="token punctuation">]</span># openstack service create <span class="token operator">--</span>name neutron <span class="token operator">--</span>description <span class="token string">"OpenStack Networking"</span> network
</code></pre>
<br>
<h3><a id="5_neutron_65"></a>5. 创建neutron服务端点</h3>
<pre><code class="prism language-cpp"><span class="token punctuation">[</span>root@controller <span class="token operator">~</span><span class="token punctuation">]</span># openstack endpoint create <span class="token operator">--</span>region RegionOne network <span class="token keyword">public</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.112</span><span class="token number">.146</span><span class="token operator">:</span><span class="token number">9696</span>

<span class="token punctuation">[</span>root@controller <span class="token operator">~</span><span class="token punctuation">]</span># openstack endpoint create <span class="token operator">--</span>region RegionOne network internal http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.112</span><span class="token number">.146</span><span class="token operator">:</span><span class="token number">9696</span>

<span class="token punctuation">[</span>root@controller <span class="token operator">~</span><span class="token punctuation">]</span># openstack endpoint create <span class="token operator">--</span>region RegionOne network admin http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.112</span><span class="token number">.146</span><span class="token operator">:</span><span class="token number">9696</span>
</code></pre>
<br>
<h3><a id="6__77"></a>6. 安装软件包{配置二层网络}</h3>
<pre><code class="prism language-cpp"><span class="token punctuation">[</span>root@controller <span class="token operator">~</span><span class="token punctuation">]</span># yum install openstack<span class="token operator">-</span>neutron openstack<span class="token operator">-</span>neutron<span class="token operator">-</span>ml2 openstack<span class="token operator">-</span>neutron<span class="token operator">-</span>linuxbridge ebtables conntrack<span class="token operator">-</span>tools <span class="token operator">-</span>y 
</code></pre>
<p>说明：<br>
&nbsp;  &nbsp;  &nbsp;  &nbsp; openstack-neutron：neutron-server的包</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; openstack-neutron-ml2：ML2 plugin的包</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; openstack-neutron-linuxbridge：linux bridge network provider相关的包</p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; ebtables：防火墙相关的包，配置iptables规则</p>
<br>
<h3><a id="7__neutron__95"></a>7. 修改 neutron 配置文件</h3>
<h4><a id="1neutron_serverneutronconf_96"></a>（1）neutron server的配置文件neutron.conf</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 精简配置neutron.conf配置文件</p>
<pre><code class="prism language-cpp"><span class="token punctuation">[</span>root@controller <span class="token operator">~</span><span class="token punctuation">]</span># cp <span class="token operator">-</span>a <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf<span class="token punctuation">{</span><span class="token punctuation">,</span><span class="token punctuation">.</span>bak<span class="token punctuation">}</span> 
<span class="token punctuation">[</span>root@controller <span class="token operator">~</span><span class="token punctuation">]</span># grep <span class="token operator">-</span>Ev <span class="token string">'^$|#'</span> <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>bak <span class="token operator">&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf 
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 设置mysql连接地址</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf database connection mysql<span class="token operator">+</span>pymysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>neutron<span class="token operator">:</span>NEUTRON_DBPASS@<span class="token number">192.168</span><span class="token number">.112</span><span class="token number">.146</span><span class="token operator">/</span>neutron 
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 设置二层网络core-plugin为ML2</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf DEFAULT core_plugin ml2 
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 设置三层网络插件service-plugin为router</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf DEFAULT service_plugins router
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 配置rabbitmq连接</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf DEFAULT transport_url rabbit<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>openstack<span class="token operator">:</span>RABBIT_PASS@<span class="token number">192.168</span><span class="token number">.112</span><span class="token number">.146</span> 
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 设置认证方式为keystone</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf DEFAULT auth_strategy keystone 
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 当网络接口发生变化时，通知给计算节点</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf DEFAULT notify_nova_on_port_status_changes <span class="token boolean">true</span> 
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 当端口数据发生变化，通知计算节点</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf DEFAULT notify_nova_on_port_data_changes <span class="token boolean">true</span> 
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 配置keystone的认证地址url</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf keystone_authtoken www_authenticate_uri http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.112</span><span class="token number">.146</span><span class="token operator">:</span><span class="token number">5000</span> 
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 配置keystone的认证地址uri</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf keystone_authtoken auth_url http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.112</span><span class="token number">.146</span><span class="token operator">:</span><span class="token number">5000</span>
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; Memcached服务器地址</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf keystone_authtoken memcached_servers <span class="token number">192.168</span><span class="token number">.112</span><span class="token number">.146</span><span class="token operator">:</span><span class="token number">11211</span> 
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 认证方式为password</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf keystone_authtoken auth_type password 
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 项目所属Domain为default</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf keystone_authtoken project_domain_name <span class="token keyword">default</span> 
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 用户所属Domain为default</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf keystone_authtoken user_domain_name <span class="token keyword">default</span> 
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 认证所属项目service</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf keystone_authtoken project_name service 
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 认证的用户名为neutron</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf keystone_authtoken username neutron 
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 认证的密码：NEUTRON_PASS</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf keystone_authtoken password NEUTRON_PASS 
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 配置锁的路径</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf oslo_concurrency lock_path <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>neutron<span class="token operator">/</span>tmp 
</code></pre>
<p>neutron需要给nova返回数据：<br>
&nbsp;  &nbsp;  &nbsp;  &nbsp; 设置nova的认证地址：</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set  <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf nova  auth_url http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.112</span><span class="token number">.146</span><span class="token operator">:</span><span class="token number">5000</span>
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 设置nova 的认证方式</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set  <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf nova  auth_type password
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 设置nova的项目所属Domain为default</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set  <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf nova  project_domain_name <span class="token keyword">default</span>
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 设置nova的用户所属Domain为default</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set  <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf nova  user_domain_name <span class="token keyword">default</span>
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 设置nova的Region名称</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set  <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf nova  region_name RegionOne
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 设置nova的项目名为service</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set  <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf nova  project_name service
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 设置nova的用户名为nova</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set  <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf nova  username nova
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 设置nova的密码为NOVA_PASS</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set  <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf nova  password NOVA_PASS
</code></pre>
<br>
<h4><a id="2ML2_pluginml2_confini_260"></a>（2）ML2 plugin的配置文件ml2_conf.ini</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 精简ml2_conf.ini配置文件：</p>
<pre><code class="prism language-cpp"><span class="token punctuation">[</span>root@controller <span class="token operator">~</span><span class="token punctuation">]</span># cp <span class="token operator">-</span>a <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>ml2_conf<span class="token punctuation">.</span>ini<span class="token punctuation">{</span><span class="token punctuation">,</span><span class="token punctuation">.</span>bak<span class="token punctuation">}</span> 
<span class="token punctuation">[</span>root@controller <span class="token operator">~</span><span class="token punctuation">]</span># grep <span class="token operator">-</span>Ev <span class="token string">'^$|#'</span> <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>ml2_conf<span class="token punctuation">.</span>ini<span class="token punctuation">.</span>bak <span class="token operator">&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>ml2_conf<span class="token punctuation">.</span>ini 
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 配置驱动类型；单一扁平网络(桥接)和vlan；让二层网络支持桥接，支持基于vlan做子网划分</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>ml2_conf<span class="token punctuation">.</span>ini ml2 type_drivers flat<span class="token punctuation">,</span>vlan<span class="token punctuation">,</span>vxlan
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 租户网络类型</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>ml2_conf<span class="token punctuation">.</span>ini ml2 tenant_network_types vxlan
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 启用Linuxbridge和l2机制，(l2population机制是为了简化网络通信拓扑，减少网络广播)：</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>ml2_conf<span class="token punctuation">.</span>ini ml2 mechanism_drivers linuxbridge<span class="token punctuation">,</span>l2population
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 启用端口安全扩展驱动程序，基于iptables实现访问控制；但配置了扩展安全组会导致一些端口限制，造成一些服务无法启动</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>ml2_conf<span class="token punctuation">.</span>ini ml2 extension_drivers port_security 
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 配置公共虚拟网络为flat网络</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>ml2_conf<span class="token punctuation">.</span>ini ml2_type_flat flat_networks provider 
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 为私有网络配置VXLAN网络识别的网络范围</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>ml2_conf<span class="token punctuation">.</span>ini ml2_type_vxlan vni_ranges <span class="token number">1</span><span class="token operator">:</span><span class="token number">1000</span>
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 启用 ipset 增加安全组的方便性</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>ml2_conf<span class="token punctuation">.</span>ini securitygroup enable_ipset <span class="token boolean">true</span>
</code></pre>
<br>
<h4><a id="3linux_bridge_network_providerlinuxbridge_agentini_313"></a>（3）linux bridge network provider的配置文件linuxbridge_agent.ini</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 精简配置文件linuxbridge_agent.ini：</p>
<pre><code class="prism language-cpp"><span class="token punctuation">[</span>root@controller <span class="token operator">~</span><span class="token punctuation">]</span># cp <span class="token operator">-</span>a <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>linuxbridge_agent<span class="token punctuation">.</span>ini<span class="token punctuation">{</span><span class="token punctuation">,</span><span class="token punctuation">.</span>bak<span class="token punctuation">}</span> 
<span class="token punctuation">[</span>root@controller <span class="token operator">~</span><span class="token punctuation">]</span># grep <span class="token operator">-</span>Ev <span class="token string">'^$|#'</span> <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>linuxbridge_agent<span class="token punctuation">.</span>ini<span class="token punctuation">.</span>bak <span class="token operator">&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>linuxbridge_agent<span class="token punctuation">.</span>ini 
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 配置物理网卡的映射，provider表示该节点可用的物理网络名字(physical network, 名字可以随便定义)，physical_interface_mappings用来把名字和该网络使用的物理网卡对应起来。<br>
&nbsp;  &nbsp;  &nbsp;  &nbsp; 后面的就是该名称对应的物理网卡。</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>linuxbridge_agent<span class="token punctuation">.</span>ini linux_bridge physical_interface_mappings provider<span class="token operator">:</span>ens33
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 允许用户创建自定义网络(3层网络)</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>linuxbridge_agent<span class="token punctuation">.</span>ini vxlan enable_vxlan <span class="token boolean">true</span>
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 启用安全组并配置 Linux 桥接 iptables 防火墙驱动</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>linuxbridge_agent<span class="token punctuation">.</span>ini securitygroup enable_security_group <span class="token boolean">true</span> 
</code></pre>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>linuxbridge_agent<span class="token punctuation">.</span>ini securitygroup firewall_driver neutron<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>iptables_firewall<span class="token punctuation">.</span>IptablesFirewallDriver 
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 控制节点IP地址</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>linuxbridge_agent<span class="token punctuation">.</span>ini vxlan local_ip <span class="token number">192.168</span><span class="token number">.112</span><span class="token number">.146</span>		
</code></pre>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>linuxbridge_agent<span class="token punctuation">.</span>ini vxlan l2_population <span class="token boolean">true</span>
</code></pre>
<br>
<h3><a id="8_357"></a>8.修改内核参数</h3>
<pre><code class="prism language-cpp">echo <span class="token string">'net.bridge.bridge-nf-call-iptables=1'</span> <span class="token operator">&gt;&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>conf
echo <span class="token string">'net.bridge.bridge-nf-call-ip6tables=1'</span> <span class="token operator">&gt;&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>conf
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 表示向内核加入参数</p>
<pre><code class="prism language-cpp">modprobe br_netfilter	
</code></pre>
<pre><code class="prism language-cpp">sysctl <span class="token operator">-</span>p
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20210628182239156.png" alt="在这里插入图片描述"></p>
<br>
<h3><a id="9Linuxbridge_379"></a>9.配置Linuxbridge接口驱动和外部网络网桥</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 精简l3_agent.ini配置文件</p>
<pre><code class="prism language-cpp">cp <span class="token operator">-</span>a <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>l3_agent<span class="token punctuation">.</span>ini<span class="token punctuation">{</span><span class="token punctuation">,</span><span class="token punctuation">.</span>bak<span class="token punctuation">}</span>
grep <span class="token operator">-</span>Ev <span class="token string">'^$|#'</span> <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>l3_agent<span class="token punctuation">.</span>ini<span class="token punctuation">.</span>bak <span class="token operator">&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>l3_agent<span class="token punctuation">.</span>ini
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 接口驱动为linuxbridge</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>l3_agent<span class="token punctuation">.</span>ini DEFAULT interface_driver linuxbridge
</code></pre>
<br>
<h3><a id="10dhcp_agent__396"></a>10.修改dhcp_agent 配置文件</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 精简dhcp_agent.ini配置文件：</p>
<pre><code class="prism language-cpp"> cp <span class="token operator">-</span>a <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>dhcp_agent<span class="token punctuation">.</span>ini<span class="token punctuation">{</span><span class="token punctuation">,</span><span class="token punctuation">.</span>bak<span class="token punctuation">}</span>
 grep <span class="token operator">-</span>Ev <span class="token string">'^$|#'</span> <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>dhcp_agent<span class="token punctuation">.</span>ini<span class="token punctuation">.</span>bak <span class="token operator">&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>dhcp_agent<span class="token punctuation">.</span>ini 
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 指定默认接口驱动为linux网桥</p>
<pre><code class="prism language-cpp"> openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>dhcp_agent<span class="token punctuation">.</span>ini DEFAULT interface_driver linuxbridge
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 指定DHCP驱动</p>
<pre><code class="prism language-cpp"> openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>dhcp_agent<span class="token punctuation">.</span>ini DEFAULT dhcp_driver neutron<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>dhcp<span class="token punctuation">.</span>Dnsmasq
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 开启iso元数据</p>
<pre><code class="prism language-cpp"> openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>dhcp_agent<span class="token punctuation">.</span>ini DEFAULT enable_isolated_metadata <span class="token boolean">true</span>
</code></pre>
<br>
<h3><a id="11_nova_424"></a>11. 配置元数据代理，以便和nova通讯</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 精简配置文件：</p>
<pre><code class="prism language-cpp"><span class="token punctuation">[</span>root@controller <span class="token operator">~</span><span class="token punctuation">]</span># cp <span class="token operator">-</span>a <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>metadata_agent<span class="token punctuation">.</span>ini<span class="token punctuation">{</span><span class="token punctuation">,</span><span class="token punctuation">.</span>bak<span class="token punctuation">}</span> 
<span class="token punctuation">[</span>root@controller <span class="token operator">~</span><span class="token punctuation">]</span># grep <span class="token operator">-</span>Ev <span class="token string">'^$|#'</span> <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>metadata_agent<span class="token punctuation">.</span>ini<span class="token punctuation">.</span>bak <span class="token operator">&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>metadata_agent<span class="token punctuation">.</span>ini 
</code></pre>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>metadata_agent<span class="token punctuation">.</span>ini DEFAULT nova_metadata_host controller 
</code></pre>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>metadata_agent<span class="token punctuation">.</span>ini DEFAULT metadata_proxy_shared_secret METADATA_SECRET
</code></pre>
<br>
<h3><a id="12novaneutron_445"></a>12.修改nova配置文件，用于neutron交互</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 修改nova.conf配置文件，添加neutron的信息，便于与neutron的交互：</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>nova<span class="token operator">/</span>nova<span class="token punctuation">.</span>conf neutron url http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.112</span><span class="token number">.146</span><span class="token operator">:</span><span class="token number">9696</span>
openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>nova<span class="token operator">/</span>nova<span class="token punctuation">.</span>conf neutron auth_url http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.112</span><span class="token number">.146</span><span class="token operator">:</span><span class="token number">5000</span>
openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>nova<span class="token operator">/</span>nova<span class="token punctuation">.</span>conf neutron auth_type password
openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>nova<span class="token operator">/</span>nova<span class="token punctuation">.</span>conf neutron project_domain_name <span class="token keyword">default</span>
openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>nova<span class="token operator">/</span>nova<span class="token punctuation">.</span>conf neutron user_domain_name <span class="token keyword">default</span>
openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>nova<span class="token operator">/</span>nova<span class="token punctuation">.</span>conf neutron region_name RegionOne
openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>nova<span class="token operator">/</span>nova<span class="token punctuation">.</span>conf neutron project_name service
openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>nova<span class="token operator">/</span>nova<span class="token punctuation">.</span>conf neutron username neutron
openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>nova<span class="token operator">/</span>nova<span class="token punctuation">.</span>conf neutron password NEUTRON_PASS
openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>nova<span class="token operator">/</span>nova<span class="token punctuation">.</span>conf neutron service_metadata_proxy <span class="token boolean">true</span>
openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>nova<span class="token operator">/</span>nova<span class="token punctuation">.</span>conf neutron metadata_proxy_shared_secret METADATA_SECRET
</code></pre>
<br>
<h3><a id="13ML2_464"></a>13.创建ML2插件文件符号连接</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 网络服务初始化脚本需要/etc/neutron/plugin.ini指向ML2插件配置文件的符号链接</p>
<pre><code class="prism language-cpp">ln <span class="token operator">-</span>s <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>ml2_conf<span class="token punctuation">.</span>ini <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugin<span class="token punctuation">.</span>ini
</code></pre>
<br>
<h3><a id="14_474"></a>14.初始化数据库</h3>
<pre><code class="prism language-cpp"> su <span class="token operator">-</span>s <span class="token operator">/</span>bin<span class="token operator">/</span>sh <span class="token operator">-</span>c "neutron<span class="token operator">-</span>db<span class="token operator">-</span>manage <span class="token operator">--</span>config<span class="token operator">-</span>file <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf 
<span class="token operator">--</span>config<span class="token operator">-</span>file <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>ml2_conf<span class="token punctuation">.</span>ini upgrade head" neutron
</code></pre>
<br>
<h3><a id="15novaapi_483"></a>15.重启计算节点nova-api服务</h3>
<pre><code class="prism language-cpp">systemctl restart openstack<span class="token operator">-</span>nova<span class="token operator">-</span>api<span class="token punctuation">.</span>service
</code></pre>
<br>
<h3><a id="16neutron_492"></a>16.开启neutron服务、设置开机自启动</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 开机自启动下面的四个neutron子服务：</p>
<pre><code class="prism language-cpp"><span class="token punctuation">[</span>root@ct <span class="token operator">~</span><span class="token punctuation">]</span># systemctl enable neutron<span class="token operator">-</span>server<span class="token punctuation">.</span>service \
neutron<span class="token operator">-</span>linuxbridge<span class="token operator">-</span>agent<span class="token punctuation">.</span>service neutron<span class="token operator">-</span>dhcp<span class="token operator">-</span>agent<span class="token punctuation">.</span>service \
neutron<span class="token operator">-</span>metadata<span class="token operator">-</span>agent<span class="token punctuation">.</span>service
<span class="token punctuation">[</span>root@ct <span class="token operator">~</span><span class="token punctuation">]</span># systemctl start neutron<span class="token operator">-</span>server<span class="token punctuation">.</span>service \
neutron<span class="token operator">-</span>linuxbridge<span class="token operator">-</span>agent<span class="token punctuation">.</span>service neutron<span class="token operator">-</span>dhcp<span class="token operator">-</span>agent<span class="token punctuation">.</span>service \
neutron<span class="token operator">-</span>metadata<span class="token operator">-</span>agent<span class="token punctuation">.</span>service
</code></pre>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 检查neutron服务的启动情况，</p>
<p><img src="https://img-blog.csdnimg.cn/20210628182315654.png" alt="在这里插入图片描述"></p>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 因为配置了第三层L3网络服务、所以需要启动第三层服务</p>
<pre><code class="prism language-cpp"><span class="token punctuation">[</span>root@ct <span class="token operator">~</span><span class="token punctuation">]</span># systemctl enable neutron<span class="token operator">-</span>l3<span class="token operator">-</span>agent<span class="token punctuation">.</span>service
<span class="token punctuation">[</span>root@ct <span class="token operator">~</span><span class="token punctuation">]</span># systemctl restart neutron<span class="token operator">-</span>l3<span class="token operator">-</span>agent<span class="token punctuation">.</span>service
</code></pre>
<br>
<h2><a id="Computeneutron_518"></a>（二）Compute节点安装neutron服务</h2>
<h3><a id="1__519"></a>1. 安装组件</h3>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; ipset：iptables的扩展，允许匹配规则的集合而不仅仅是一个IP</p>
<pre><code class="prism language-cpp"><span class="token punctuation">[</span>root@compute01 <span class="token operator">~</span><span class="token punctuation">]</span># yum install openstack<span class="token operator">-</span>neutron<span class="token operator">-</span>linuxbridge ebtables ipset conntrack<span class="token operator">-</span>tools <span class="token operator">-</span>y
</code></pre>
<br>
<h3><a id="2__529"></a>2. 修改配置文件</h3>
<h4><a id="1neutron_530"></a>（1）修改neutron主配置文件</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 精简neutron.conf配置文件</p>
<pre><code class="prism language-cpp"><span class="token punctuation">[</span>root@compute01 <span class="token operator">~</span><span class="token punctuation">]</span># cp <span class="token operator">-</span>a <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf<span class="token punctuation">{</span><span class="token punctuation">,</span><span class="token punctuation">.</span>bak<span class="token punctuation">}</span> 
<span class="token punctuation">[</span>root@compute01 <span class="token operator">~</span><span class="token punctuation">]</span># grep <span class="token operator">-</span>Ev <span class="token string">'^$|#'</span> <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>bak <span class="token operator">&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf 
</code></pre>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf DEFAULT transport_url rabbit<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>openstack<span class="token operator">:</span>RABBIT_PASS@<span class="token number">192.168</span><span class="token number">.112</span><span class="token number">.146</span>
</code></pre>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf DEFAULT auth_strategy keystone 
</code></pre>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf keystone_authtoken www_authenticate_uri http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.112</span><span class="token number">.146</span><span class="token operator">:</span><span class="token number">5000</span> 
</code></pre>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf keystone_authtoken auth_url http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.112</span><span class="token number">.146</span><span class="token operator">:</span><span class="token number">5000</span> 
</code></pre>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf keystone_authtoken memcached_servers <span class="token number">192.168</span><span class="token number">.112</span><span class="token number">.146</span><span class="token operator">:</span><span class="token number">11211</span> 
</code></pre>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf keystone_authtoken auth_type password 
</code></pre>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf keystone_authtoken project_domain_name <span class="token keyword">default</span> 
</code></pre>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf keystone_authtoken user_domain_name <span class="token keyword">default</span> 
</code></pre>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf keystone_authtoken project_name service 
</code></pre>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf keystone_authtoken username neutron 
</code></pre>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf keystone_authtoken password NEUTRON_PASS 
</code></pre>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>neutron<span class="token punctuation">.</span>conf oslo_concurrency lock_path <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>neutron<span class="token operator">/</span>tmp
</code></pre>
<br>
<h4><a id="2Linuxlinuxbridge_agentini_596"></a>（2）配置Linux网桥代理linuxbridge_agent.ini</h4>
<p>&nbsp;  &nbsp;  &nbsp;  &nbsp; 精简配置文件：</p>
<pre><code class="prism language-cpp">cp <span class="token operator">-</span>a <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>linuxbridge_agent<span class="token punctuation">.</span>ini<span class="token punctuation">{</span><span class="token punctuation">,</span><span class="token punctuation">.</span>bak<span class="token punctuation">}</span>
grep <span class="token operator">-</span>Ev <span class="token string">'^$|#'</span> <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>linuxbridge_agent<span class="token punctuation">.</span>ini<span class="token punctuation">.</span>bak <span class="token operator">&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>linuxbridge_agent<span class="token punctuation">.</span>ini
</code></pre>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>linuxbridge_agent<span class="token punctuation">.</span>ini linux_bridge physical_interface_mappings  provider<span class="token operator">:</span>ens33
</code></pre>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>linuxbridge_agent<span class="token punctuation">.</span>ini vxlan enable_vxlan  <span class="token boolean">true</span>
</code></pre>
<p>Compute节点的IP</p>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>linuxbridge_agent<span class="token punctuation">.</span>ini vxlan local_ip <span class="token number">192.168</span><span class="token number">.112</span><span class="token number">.145</span>
</code></pre>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>linuxbridge_agent<span class="token punctuation">.</span>ini vxlan l2_population <span class="token boolean">true</span>
</code></pre>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>linuxbridge_agent<span class="token punctuation">.</span>ini securitygroup enable_security_group  <span class="token boolean">true</span>
</code></pre>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>neutron<span class="token operator">/</span>plugins<span class="token operator">/</span>ml2<span class="token operator">/</span>linuxbridge_agent<span class="token punctuation">.</span>ini securitygroup firewall_driver  neutron<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>iptables_firewall<span class="token punctuation">.</span>IptablesFirewallDriver
</code></pre>
<br>
<h4><a id="3_636"></a>（3）修改内核</h4>
<p>允许虚拟机的数据通过物理机出去</p>
<pre><code class="prism language-cpp">echo <span class="token string">'net.bridge.bridge-nf-call-iptables=1'</span> <span class="token operator">&gt;&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>conf		
echo <span class="token string">'net.bridge.bridge-nf-call-ip6tables=1'</span> <span class="token operator">&gt;&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>conf
</code></pre>
<p>modprobe：用于向内核中加载模块，或者从内核中移除模块。modprobe -r 表示移除</p>
<pre><code class="prism language-cpp">modprobe br_netfilter		
</code></pre>
<pre><code class="prism language-cpp">sysctl <span class="token operator">-</span>p
</code></pre>
<br>
<h3><a id="3_novaconf_655"></a>3. 修改nova.conf配置文件</h3>
<pre><code class="prism language-cpp">openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>nova<span class="token operator">/</span>nova<span class="token punctuation">.</span>conf neutron auth_url http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.112</span><span class="token number">.146</span><span class="token operator">:</span><span class="token number">5000</span>
openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>nova<span class="token operator">/</span>nova<span class="token punctuation">.</span>conf neutron auth_type password
openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>nova<span class="token operator">/</span>nova<span class="token punctuation">.</span>conf neutron project_domain_name <span class="token keyword">default</span>
openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>nova<span class="token operator">/</span>nova<span class="token punctuation">.</span>conf neutron user_domain_name <span class="token keyword">default</span>
openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>nova<span class="token operator">/</span>nova<span class="token punctuation">.</span>conf neutron region_name RegionOne
openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>nova<span class="token operator">/</span>nova<span class="token punctuation">.</span>conf neutron project_name service
openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>nova<span class="token operator">/</span>nova<span class="token punctuation">.</span>conf neutron username neutron
openstack<span class="token operator">-</span>config <span class="token operator">--</span>set <span class="token operator">/</span>etc<span class="token operator">/</span>nova<span class="token operator">/</span>nova<span class="token punctuation">.</span>conf neutron password NEUTRON_PASS
</code></pre>
<br>
<h3><a id="4_nova_670"></a>4. 重启nova计算服务</h3>
<pre><code class="prism language-cpp">systemctl restart openstack<span class="token operator">-</span>nova<span class="token operator">-</span>compute<span class="token punctuation">.</span>service
</code></pre>
<br>
<h3><a id="5_neutron_678"></a>5. 启动neutron服务和设置开机自启动</h3>
<pre><code class="prism language-cpp">systemctl enable neutron<span class="token operator">-</span>linuxbridge<span class="token operator">-</span>agent<span class="token punctuation">.</span>service 
systemctl start neutron<span class="token operator">-</span>linuxbridge<span class="token operator">-</span>agent<span class="token punctuation">.</span>service
</code></pre>
<br>
<h2><a id="ControllerNeutron_687"></a>（三）Controller节点中验证Neutron服务的安装</h2>
<pre><code class="prism language-cpp"><span class="token punctuation">[</span>root@controller <span class="token operator">~</span><span class="token punctuation">]</span># openstack extension list <span class="token operator">--</span>network
</code></pre>
<pre><code class="prism language-cpp"><span class="token punctuation">[</span>root@controller <span class="token operator">~</span><span class="token punctuation">]</span># openstack network agent list
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20210628182331815.png" alt="在这里插入图片描述"></p>
<p>或者从内核中移除模块。modprobe -r 表示移除可以看到，Controller节点中有4个Neutron子服务，Compute节点中有一个Neutron子服务，State都是Up。<br>
<br></p>
<h2><a id="_705"></a>（四）总结部署思路</h2>
<p>配置neutron组件的用户、认证、endpoint<br>
设置提供者provider网络（这里是桥接模式）<br>
① 配置二层网络<br>
② 配置网桥（插件）<br>
③ 优化内核<br>
④ 配置网桥接口与外部对接<br>
⑤ 修改DHCP配置（修改配置文件、代理）<br>
⑥ 配置网桥与内部组件的配置（修改配置文件、代理）<br>
设置neutron与nova对接的配置</p>
</div>
</body>

</html>
